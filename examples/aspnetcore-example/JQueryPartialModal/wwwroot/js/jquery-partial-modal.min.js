/*!
 * jQuery plugin to load Bootstrap modals with ASP.NET Core partial views v1.0
 * 
 * Authors: Paolo Gaetano
 * Copyright (c) 2026 Paolo Gaetano
 * Released under the MIT license
 */
!function($){function loadModal(options){const settings=$.extend({},{url:"",data:{},method:"POST",title:"Modal",size:"",loadingText:"Loading...",errorText:"Failed to load content. Please try again.",onLoaded:function(){},onSubmit:null,onSuccess:null,onError:null,triggerElement:null},options);let modal=$("#partialModal");0===modal.length&&(modal=$(`\n                <div class="modal fade" id="partialModal" tabindex="-1" aria-hidden="true">\n                    <div class="modal-dialog">\n                        <div class="modal-content">\n                            <div class="modal-header">\n                                <h5 class="modal-title"></h5>\n                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                            </div>\n                            <div class="modal-body">\n                                <div class="text-center py-4">\n                                    <div class="spinner-border" role="status">\n                                        <span class="visually-hidden">${settings.loadingText}</span>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="modal-footer"></div>\n                        </div>\n                    </div>\n                </div>\n            `).appendTo("body"));const modalDialog=modal.find(".modal-dialog");modalDialog.removeClass("modal-sm modal-lg modal-xl"),settings.size&&modalDialog.addClass(settings.size),modal.find(".modal-title").text(settings.title);const modalBody=modal.find(".modal-body"),modalFooter=modal.find(".modal-footer");modalBody.html(`\n            <div class="text-center py-4">\n                <div class="spinner-border" role="status">\n                    <span class="visually-hidden">${settings.loadingText}</span>\n                </div>\n            </div>\n        `),modalFooter.empty();const existingInstance=bootstrap.Modal.getInstance(modal[0]);existingInstance&&existingInstance.dispose(),modal.off("hidden.bs.modal.partialModal");const bootstrapModal=new bootstrap.Modal(modal[0]);return $.ajax({url:settings.url,method:settings.method,data:settings.data,dataType:"html",success:function(partialHtml){modalBody.html(partialHtml);const partialFooter=modalBody.find(".modal-footer-content");if(partialFooter.length&&(modalFooter.html(partialFooter.html()),partialFooter.remove()),settings.onLoaded(modal),$.validator&&$.validator.unobtrusive&&$.validator.unobtrusive.parse(modalBody.find("form")),"function"==typeof settings.onSubmit){const form=modalBody.find("form");form.off("submit.partialModal");const handleSubmit=function(e){e.preventDefault();const currentForm=modalBody.find("form"),formData=new FormData(currentForm[0]);settings.onSubmit(formData,(function(result){if(result.success)bootstrapModal.hide();else if(result.html){modalBody.html(result.html),$.validator&&$.validator.unobtrusive&&$.validator.unobtrusive.parse(modalBody.find("form"));const newForm=modalBody.find("form");newForm.off("submit.partialModal").on("submit.partialModal",handleSubmit);const newPartialFooter=modalBody.find(".modal-footer-content");newPartialFooter.length&&(modalFooter.html(newPartialFooter.html()),newPartialFooter.remove(),modalFooter.find('button[type="submit"]').off("click.partialModal").on("click.partialModal",(function(e){e.preventDefault(),newForm.trigger("submit.partialModal")})))}}))};form.on("submit.partialModal",handleSubmit),modalFooter.find('button[type="submit"]').off("click.partialModal").on("click.partialModal",(function(e){e.preventDefault(),form.trigger("submit.partialModal")}))}},error:function(xhr,status,error){modalBody.html(`<div class="alert alert-danger" role="alert">${settings.errorText}</div>`);const errorData={xhr:xhr,status:status,error:error,message:settings.errorText};settings.onError&&"function"==typeof settings.onError&&settings.onError(errorData),settings.triggerElement&&settings.triggerElement.trigger("error.partialModal",[errorData])}}),bootstrapModal.show(),modal.on("hidden.bs.modal.partialModal",(function(){modalBody.find("form").off("submit.partialModal"),modalFooter.find('button[type="submit"]').off("click.partialModal"),modalBody.empty(),modalFooter.empty(),bootstrapModal&&"function"==typeof bootstrapModal.dispose&&bootstrapModal.dispose()})),$()}$.fn.loadPartialModal=function(options){return this.length>1||1===this.length&&!options?this.each((function(){const $element=$(this);$element.off("click.partialModal"),$element.on("click.partialModal",(function(e){e.preventDefault();const dataOptions={url:$element.data("modal-url")||$element.attr("href")||"",method:$element.data("modal-method")||"POST",title:$element.data("modal-title")||"Modal",size:$element.data("modal-size")||"",data:$element.data("modal-data")||{},loadingText:$element.data("modal-loading-text")||"Loading...",errorText:$element.data("modal-error-text")||"Failed to load content. Please try again.",triggerElement:$element};if("string"==typeof dataOptions.data)try{dataOptions.data=JSON.parse(dataOptions.data)}catch(e){console.warn("Invalid JSON in data-modal-data attribute"),dataOptions.data={}}const onLoadedFnName=$element.data("modal-on-loaded");onLoadedFnName&&"function"==typeof window[onLoadedFnName]?dataOptions.onLoaded=window[onLoadedFnName]:dataOptions.onLoaded=function(modal){$element.trigger("loaded.partialModal",[modal])};const onSuccessFnName=$element.data("modal-on-success"),onSuccessFn=onSuccessFnName&&"function"==typeof window[onSuccessFnName]?window[onSuccessFnName]:null,onErrorFnName=$element.data("modal-on-error"),onErrorFn=onErrorFnName&&"function"==typeof window[onErrorFnName]?window[onErrorFnName]:null;onErrorFn&&(dataOptions.onError=onErrorFn);const submitUrl=$element.data("modal-submit-url");submitUrl&&(dataOptions.onSubmit=function(formData,callback){$.ajax({url:submitUrl,method:"POST",data:formData,processData:!1,contentType:!1,dataType:"json",success:function(result){if(callback(result),result.success){const hasCustomHandler=onSuccessFn||$element.data("hasSuccessHandler");$("#partialModal").one("hidden.bs.modal",(function(){onSuccessFn&&onSuccessFn(result),$element.trigger("success.partialModal",[result]),result.message&&!hasCustomHandler&&alert(result.message)}))}},error:function(xhr){if(200===xhr.status&&xhr.responseText)callback({success:!1,html:xhr.responseText});else{const errorData={success:!1,message:"Submission failed",xhr:xhr};callback(errorData),onErrorFn&&onErrorFn(errorData),$element.trigger("error.partialModal",[errorData])}}})});const beforeLoadEvent=$.Event("beforeLoad.partialModal",{settings:dataOptions});$element.trigger(beforeLoadEvent),beforeLoadEvent.isDefaultPrevented()||loadModal(dataOptions)}))})):loadModal(options||{})}}(jQuery);